<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>IA</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <h1>IA!</h1>
    
    <p id="f1_upload_process">Loading...<br/><img src="loader.gif" /></p><br />
    <p id="result"></p>
    <p>Upload a CSV to train your model</p>
    <form action="/api" id="uploader" method="post" enctype="multipart/form-data">
      Select a file: <input type="file" name="upload" />
      <input type="submit" value="Start upload" />
      <input type="text" name="endpoint" value="upload_csv" hidden/>
    </form>               
    <div id="types"></div>
    <input type="submit" id='btn_train' value="Start Training" onclick="startTraining();" hidden />
    <div id="graphs">
    </div>
    
    

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>
<script>
var model = "";
$('#uploader').submit(function(e) {
    startUpload();
    e.preventDefault();
    var data = new FormData(this);
    data.endpoint = 'upload_csv';
    $.ajax({
        type: 'POST',
        url: '/api',
        data: data,
        contentType: false,
        processData: false,
        success: function(response) {
            try {
                JSON.parse(response);
            } catch (e) {
                alert(response);
                document.getElementById('f1_upload_process').style.visibility = 'hidden';
                return;
            }
            stopUpload(JSON.parse(response));
        },
        error : function(response) {
            alert(response);
            document.getElementById('f1_upload_process').style.visibility = 'hidden';
        }
    });
});

function startTraining() {
  if (model == "") {
    return;
  }
  $.post('/api',
        {'endpoint': 'train',
         'handle': model},
        function(response) {
          response = JSON.parse(response);
          if (response['status'] != 'OK') {
            alert(response);
          }
        }
  );
  doPoll(model);
}

function createGraphs(response) {
  for (var key in response['val_losses']) {
    var valLoss = response["val_losses"][key]["val_loss"];
    var loss = response["val_losses"][key]["loss"];
    var data = [];
    var j = 0;
    if (valLoss.length > 200) {
      var j = valLoss.length - 200;
    }
    for (; j < valLoss.length; j++) {
      data.push({'loss': loss[j], 'valLoss':valLoss[j], 'x':j})
    }
    
    margin = {top: 40, right: 20, bottom: 40, left: 90},
    width = 500 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom;
    
    var svg = d3.select("#graphs").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .attr("id", "svg" + key)
      .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var x = d3.scaleLinear()
        .rangeRound([0, width]);

    var y = d3.scaleLinear()
        .rangeRound([height, 0]);

    var lossLine = d3.line()
        .x(function(d) {return x(d.x);})
        .y(function(d) {return y(d.loss);});
    var valLossLine = d3.line()
        .x(function(d) {return x(d.x);})
        .y(function(d) {return y(d.valLoss);});

    x.domain(d3.extent(data, function(d) { return d.x; }));
    y.domain([d3.min(data, function(d) {
	    return Math.min(d.loss, d.valLoss); }), 
	    d3.max(data, function(d) { return Math.max(d.loss, d.valLoss); })]);

    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

    svg.append("g")
        .call(d3.axisLeft(y))

    svg.append("path")
        .data([data])
        .attr("fill", "none")
        .attr("stroke", "red")
        .attr("stroke-linejoin", "round")
        .attr("stroke-linecap", "round")
        .attr("stroke-width", 1.5)
        .attr("d", lossLine);
        
    svg.append("path")
        .data([data])
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-linejoin", "round")
        .attr("stroke-linecap", "round")
        .attr("stroke-width", 1.5)
        .attr("d", valLossLine);
        
    svg.append("text")
        .attr("x", (width / 2))             
        .attr("y", 0 - (margin.top / 2))
        .attr("text-anchor", "middle")  
        .style("font-size", "16px") 
        .text("Model " + key);
  }
  
}
function updateGraphs(response) {
   $('#graphs').empty();
   createGraphs(response);
}
function doPoll(handle){
    $.post('/api', 
           {'endpoint': 'train_status',
            'handle': handle},
           function(data) {
            data = JSON.parse(data);
            if (data['status'] == 'DONE') {
              alert('training finished');
            } else {
              updateGraphs(data);
              setTimeout(function(){doPoll(handle)},10000);
            }
    });
}


function startUpload() {
    document.getElementById('f1_upload_process').style.visibility = 'visible';
    return true;
}
function stopUpload(response){
      var result = '';
      if (response['status'] == 'OK'){
         document.getElementById('result').innerHTML =
           '<span class="msg">The file ' + response['handle'] + ' was uploaded successfully!<\/span><br/><br/>';
         table = document.createElement('table');
         headers = document.createElement('tr');
         row = document.createElement('tr');
         for (var key in response['types']) {
          cell = document.createElement('td');
          cell.innerHTML = key;
          headers.append(cell);

          cell = document.createElement('td');
          cell.innerHTML = response['types'][key];
          row.append(cell);
         }
         table.append(headers);
         table.append(row);
         $('#types').append(table);
         model = response['handle'];
         $('#btn_train').show();
      }
      else {
         document.getElementById('result').innerHTML = 
           '<span class="emsg">There was an error during file upload!<\/span><br/><br/>';
      }
      document.getElementById('f1_upload_process').style.visibility = 'hidden';
      return true;   
}
</script> 
 
<style>
#f1_upload_process{
   z-index:100;
   position:absolute;
   visibility:hidden;
   text-align:center;
   width:400px;
   margin:0px;
   padding:0px;
   background-color:#fff;
   border:1px solid #ccc;
}
 
form{
   text-align:center;
   width:390px;
   margin:0px;
   padding:5px;
   background-color:#fff;
   border:1px solid #ccc;
 
}
</style>
